CC = gcc
CFLAGS += -std=gnu99 -O2 -Wall -pedantic \
	-I deps/lodepng \
	-D_POSIX_C_SOURCE=200809L \
	-D_FILE_OFFSET_BITS=64 \
	-DLODEPNG_NO_COMPILE_ANCILLARY_CHUNKS \
	-DLODEPNG_NO_COMPILE_CPP \
	-DLODEPNG_NO_COMPILE_ALLOCATORS \
	-DLODEPNG_NO_COMPILE_ENCODER
LDFLAGS += -lm -lcomctl32

OBJS = png2pos.o png2pos.res deps/lodepng/lodepng.o
EXEC = png2pos.exe

all : $(EXEC)

strip : $(EXEC)
	-strip --strip-unneeded $<

.PHONY : clean
clean :
	-del $(OBJS) $(EXEC)
	-del *.pos *.gz

$(EXEC) : $(OBJS)
	$(CC) $(OBJS) $(LDFLAGS) -o $@

%.o : %.c
	$(CC) -c $(CFLAGS) -o $@ $<

deps/lodepng/%.o : deps/lodepng/%.c
	$(CC) -x c -c $(CFLAGS) -o $@ $<

%.res : %.rc
	windres -J rc -O coff -o $@ $<

sign :
	signtool sign /t http://timestamp.verisign.com/scripts/timstamp.dll /f petr.kutalek.codesign.pfx /d png2pos.exe png2pos.exe
